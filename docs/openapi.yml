openapi: 3.1.0

info:
  title: EcoPath Backend API
  version: 1.0.0

servers:
  - url: http://localhost:8000
  - url: https://backendapi.ecopath.site

paths:
  /api/users:
    post:
      summary: Create a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveUserInput'
      responses:
        '201':
          description: Resource created
          headers:
            Location:
              description: URL of the newly created user
              schema:
                type: string
                
  /api/smart-meters:
    get:
      summary: Get all smart meters
      responses:
        '200':
          description: List of smart meters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAllSmartMetersOutput'

  /api/waste-scans:
    get:
      summary: Get all waste scans
      responses:
        '200':
          description: List of waste scans
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAllWasteScansOutput'
    post:
      summary: Create a new waste scan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveWasteScanInput'
      responses:
        '201':
          description: Resource created
          headers:
            Location:
              description: URL of the newly created waste scan
              schema:
                type: string

  /api/pickup-requests:
    get:
      summary: Get all pickup requests
      responses:
        '200':
          description: List of pickup requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListAllPickupRequestsOutput'
    post:
      summary: Create a new pickup request
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SavePickupRequestInput'
      responses:
        '201':
          description: Resource created
          headers:
            Location:
              description: URL of the newly created pickup request
              schema:
                type: string

  /api/smart-meters/{smartMeterId}/readings:
    get:
      summary: Get sensor readings for a smart meter
      parameters:
        - name: smartMeterId
          in: path
          required: true
          schema:
            type: string
        - name: from
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          required: true
          schema:
            type: string
            format: date-time
        - name: avg
          in: query
          required: false
          schema:
            type: boolean
          description: Set to true to get average readings
        - name: interval
          in: query
          required: false
          schema:
            type: string
            enum: [day, week, month]
          description: Only used if avg=true, defines the grouping interval
      responses:
        '200':
          description: Sensor readings output
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/SensorReadingsBySmartMeterIdOutput'
                  - $ref: '#/components/schemas/AverageSensorReadingsBySmartMeterIdOutput'
                  - $ref: '#/components/schemas/GroupedAverageSensorReadingsBySmartMeterIdOutput'
  /api/smart-meters/{city}/readings/{type}:
    get:
      summary: Get sensor readings by city and type
      parameters:
        - name: city
          in: path
          required: true
          schema:
            type: string
        - name: type
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Sensor readings

  /api/carbon-footprint-records/{userId}:
    get:
      summary: Get carbon footprint records for a user
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Carbon footprint records

  /api/waste-scans/{wasteScanId}/image:
    get:
      summary: Get waste scan image
      parameters:
        - name: wasteScanId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Image for waste scan
          content:
            image/*: {}

  /api/pickup-requests/{pickupRequestId}/image:
    get:
      summary: Get pickup request image
      parameters:
        - name: pickupRequestId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Image for pickup request
          content:
            image/*: {}

components:
  schemas: 
    ListAllPickupRequestsOutput:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/PickupRequestData'
    
    ListAllWasteScansOutput:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/WasteScanData'

    ListAllSmartMetersOutput:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SmartMeterData'

    SmartMeterData:
      type: object
      required:
        - id
        - meterType
        - location
      properties:
        id:
          type: string
        meterType:
          type: string
        location:
          $ref: '#/components/schemas/Location'

    SaveUserInput:
      type: object
      required:
        - name
        - email
        - avatarImage
        - userProfile
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        avatarImage:
          type: string
          description: Base64-encoded image
        userProfile:
          type: object
          required:
            - birthDate
            - gender
            - location
            - housingType
            - householdSize
            - ecoGoals
          properties:
            birthDate:
              type: string
              format: date
            gender:
              $ref: '#/components/schemas/Gender'
            housingType:
              $ref: '#/components/schemas/HousingType'
            householdSize:
              type: integer
            ecoGoals:
              type: array
              items:
                type: string
            location:
              $ref: '#/components/schemas/Location'

    SaveWasteScanInput:
      type: object
      required:
        - image
        - timestamp
        - wasteType
        - geoLocation
      properties:
        image:
          type: string
          description: Base64-encoded image
        timestamp:
          type: string
          format: date-time
        wasteType:
          type: string
        geoLocation:
          $ref: '#/components/schemas/GeoLocation'

    SavePickupRequestInput:
      type: object
      required:
        - location
        - image
        - timestamp
      properties:
        location:
          $ref: '#/components/schemas/Location'
        image:
          type: string
          description: Base64-encoded image
        timestamp:
          type: string
          format: date-time
        notes:
          anyOf:
            - type: string
            - type: 'null'
    
    Location:
      type: object
      properties:
        houseNumber:
          type: string
        street:
          type: string
        city:
          type: string
        postalCode:
          type: string
      required:
        - houseNumber
        - street
        - city
        - postalCode
    Gender:
      type: string
      enum:
        - female
        - male
        - non_binary
        - prefer_not_to_say

    HousingType:
      type: string
      enum:
        - apartment
        - house
        - one_room_studio
        - shared_house
        - other
  
    PickupRequestData:
      type: object
      required:
        - id
        - location
        - timestamp
      properties:
        id:
          type: string
        location:
          $ref: '#/components/schemas/Location'
        timestamp:
          type: string
          format: date-time
        notes:
          type: 
            - string
            - 'null'
          

    WasteScanData:
      type: object
      required:
        - id
        - timestamp
        - wasteType
        - geoLocation
      properties:
        id:
          type: string
        timestamp:
          type: string
          format: date-time
        wasteType:
          type: string
        geoLocation:
          $ref: '#/components/schemas/GeoLocation'

    Interval:
      type: string
      enum:
        - day
        - week
        - month

    SensorReadingRecordData:
      type: object
      required:
        - timestamp
        - value
      properties:
        timestamp:
          type: string
          format: date-time
        value:
          type: number

    SensorReadingsBySmartMeterIdOutput:
      type: object
      required:
        - smartMeterId
        - type
        - from
        - to
        - unit
        - values
      properties:
        smartMeterId:
          type: string
        type:
          type: string
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        unit:
          type: string
        values:
          type: array
          items:
            $ref: '#/components/schemas/SensorReadingRecordData'

    AverageSensorReadingsBySmartMeterIdOutput:
      type: object
      required:
        - smartMeterId
        - type
        - from
        - to
        - unit
        - average
      properties:
        smartMeterId:
          type: string
        type:
          type: string
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        unit:
          type: string
        average:
          type: number

    GroupedAverageSensorReadingsBySmartMeterIdOutput:
      type: object
      required:
        - smartMeterId
        - type
        - from
        - to
        - unit
        - interval
        - values
      properties:
        smartMeterId:
          type: string
        type:
          type: string
        from:
          type: string
          format: date-time
        to:
          type: string
          format: date-time
        unit:
          type: string
        interval:
          $ref: '#/components/schemas/Interval'
        values:
          type: array
          items:
            $ref: '#/components/schemas/SensorReadingRecordData'
    
    GeoLocation:
      type: object
      required:
        - latitude
        - longitude
      properties:
        latitude:
          type: number
        longitude:
          type: number